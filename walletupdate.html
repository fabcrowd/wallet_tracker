<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEL Token Holder Analysis</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .file-input-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .file-input-box {
            border: 2px dashed #667eea;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            background: #f8f9fa;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            display: none;
            margin-top: 30px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .excluded-addresses {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .progress {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-value {
            font-size: 36px;
            font-weight: bold;
        }
        .summary-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TEL Token Holder Analysis Tool</h1>
        
        <div class="file-input-container">
            <div class="file-input-box">
                <h3>Ethereum Chain Data</h3>
                <p>Upload Ethereum TEL holders CSV</p>
                <input type="file" id="ethereumFile" accept=".csv">
                <div id="ethereumStatus"></div>
                <div id="ethereumDebug" class="debug-info"></div>
            </div>
            <div class="file-input-box">
                <h3>Polygon Chain Data</h3>
                <p>Upload Polygon TEL holders CSV</p>
                <input type="file" id="polygonFile" accept=".csv">
                <div id="polygonStatus"></div>
                <div id="polygonDebug" class="debug-info"></div>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button onclick="analyzeData()" id="analyzeBtn" disabled>Analyze Holder Distribution</button>
            <button onclick="downloadResults()" id="downloadBtn" style="display:none;">Download Full Report</button>
            <button onclick="toggleDebug()" id="debugBtn" style="background: #6c757d;">Toggle Debug</button>
        </div>
        
        <div class="progress" id="progressBar">
            <div class="progress-bar" id="progressFill">Processing...</div>
        </div>
        
        <div id="alerts"></div>
        
        <div class="results" id="results">
            <div class="summary-card" id="summaryCard"></div>
            
            <h2>Concentration Metrics (Retail Holders Only)</h2>
            <div class="metrics-grid" id="metricsGrid"></div>
            
            <h2>Excluded Non-Retail Addresses</h2>
            <div class="excluded-addresses" id="excludedAddresses"></div>
            
            <h2>Top Retail Holders</h2>
            <table id="topHoldersTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Address</th>
                        <th>Balance (TEL)</th>
                        <th>% of Supply</th>
                        <th>Chain</th>
                    </tr>
                </thead>
                <tbody id="topHoldersBody"></tbody>
            </table>
            
            <h2>Distribution Analysis</h2>
            <div id="distributionAnalysis"></div>
        </div>
    </div>

    <script>
        let ethereumData = null;
        let polygonData = null;
        let debugMode = false;
        let resultsData = null;
        
        // TEL token total supply
        const TOTAL_TEL_SUPPLY = 92577234366;
        
        // Comprehensive list of exchange and non-retail addresses to filter out
        const NON_RETAIL_ADDRESSES = [
            // === MAJOR CENTRALIZED EXCHANGES ===
            
            // Binance (all known hot/cold wallets)
            '0x28c6c06298d514db089934071355e5743bf21d60',
            '0x3f5ce5fbfe3e9af3971dd833d26ba9b5c936f0be',
            '0x564286362092d8e7936f0549571a803b203aaced',
            '0x0681d8db095565fe8a346fa0277bffde9c0edbbf',
            '0xfe9e8709d3215310075d67e3ed32a380ccf451c8',
            '0x4e9ce36e442e55ecd9025b9a6e0d88485d628a67',
            '0xbe0eb53f46cd790cd13851d5eff43d12404d33e8',
            '0xf977814e90da44bfa03b6295a0616a897441acec',
            '0x001866ae5b3de6caa5a51543fd9fb64f524f5478',
            '0x8b99f3660622e21f2910ecca7fbe51d654a1517d',
            '0xab83d182f3485cf1d6ccdd34c7cfef95b4c08da4',
            '0xc365c3315cf926351ccaf13fa7d19c8c4058c8e1',
            '0x61189da79177950a7272c88c6058b96d4bcd6be2',
            '0x4fabb145d64652a948d72533023f6e7a623c7c53',
            '0x85b931a32a0725be14285b66f1a22178c672d69b',
            '0x708396f17127c42383e3b9014072679b2f60b82f',
            '0x8f22f2063d253846b53609231ed80fa571bc0c8f',
            '0xd551234ae421e3bcba99a0da6d736074f22192ff',
            '0x4d9ff50ef4da947364bb9650892b2554e7be5e2b',
            '0x06a0abdb7e5c4fe0aa61eb9f09e222beaccd0e2a',
            '0xb8c77482e45f1f44de1745f52c74426c631bdd52',
            '0x21a31ee1afc51d94c2efccaa2092ad1028285549',
            '0xdfd5293d8e347dfe59e90efd55b2956a1343963d',
            '0x56eddb7aa87536c09ccc2793473599fd21a8b17f',
            '0x9696f59e4d72e237be84ffd425dcad154bf96976',
            '0x4e68ccd3e89f51c3074ca5072bbac773960dfa36',
            '0x6f50c6bff08ec925232937b204b0ae23c488402a',
            
            // Coinbase (all known addresses)
            '0x0639556f03714a74a5feeaf5736a4a64ff70d206',
            '0xa090e606e30bd747d4e6245a1517ebe430f0057e',
            '0x71660c4005ba85c37ccec55d0c4493e66fe775d3',
            '0x503828976d22510aad0201ac7ec88293211d23da',
            '0xddfabcdc4d8ffc6d5beaf154f18b778f892a0740',
            '0x3cd751e6b0078be393132286c442345e5dc49699',
            '0xb5d85cbf7cb3ee0d56b3bb207d5fc4b82f43f511',
            '0xeb2629a2734e272bcc07bda959863f316f4bd4cf',
            '0x02466e547bfdab679fc49e5041ff6af2765b0db4',
            '0x6b76f8b1e9e59913bfe758821887311ba1805cab',
            '0xa9d1e08c7793af67e9d92fe308d5697fb81d3e43',
            '0x77696bb39917c91a0c3908d577d5e322095425ca',
            '0x7c195d981abfdc3ddecd2ca0fed0958430488e34',
            '0x95a9bd206ae52c4ba8eecfc93d18eacdd41c88cc',
            '0x2910543af39aba0cd09dbb2d50200b3e800a63d2',
            
            // KuCoin
            '0x2b5634c42055806a59e9107ed44d43c426e58258',
            '0x061f7937b7b2bc7596539959804f86538b6368dc',
            '0xf16e9b0d03470827a95cdfd0cb8a8a3b46969b91',
            '0xd6216fc19db775df9774a6e33526131da7d19a2c',
            '0x1692e170361cefd1eb7240ec13d048fd9af6d667',
            '0xa910f92acdaf488fa6ef02174fb86208ad7722ba',
            '0xeb6d43fe241fb2320b5a3c9be9cdfd4dd8226451',
            '0xcad621da75a66c7a8f4ff86d30a2bf981bfc8fdd',
            '0x689c56aef474df92d44a1b70850f808488f9769c',
            '0xa1d8d972560c2f8144af871db508f0b0b10a3fbf',
            '0x1a1ec25dc08e98e5e93f1104b5e5cd73e09b7b09',
            '0x899b5d52671830f567bf43a14684eb14e1f945fe',
            '0x2933782b5a8d72f2754103d1489614f29bfa4625',
            
            // OKEx/OKX
            '0x6cc5f688a315f3dc28a7781717a9a798a59fda7b',
            '0x236f9f97e0e62388479bf9e5ba4889e46b0273c3',
            '0xa7efae728d2936e78bda97dc267687568dd593f3',
            '0x98ec059dc3adfbdd63429454aeb0c990fba4a128',
            '0x75e89d5979e4f6fba9f97c104c2f0afb3f1dcb88',
            '0x2c8fbb630289363ac80705a1a61273f76fd5a161',
            '0x59448fe20378357f206880c58068f095ae63d5a5',
            
            // Known large aggregators to exclude
            '0x7d032D841a64DE5c20a1f61d35025FD53443142f',	
            '0x1B14376ee2d46aE5c27A43D902d96D4F3F264B83',		
            '0xb099ed146fad4d0daa31e3810591fc0554af62bb',
            '0x802b65b5d9016621e66003aed0b16615093f328b',
            '0x77e7c5cbeaad915cf5462064b02984e16a902e67',
            '0x7d1afa7b718fb893db30a3abc0cfc608aacfebb0',
            '0x00000047bb99ea4d791bb749d970de71ee0b1a34',
            '0xb45a2dda996c32e93b8c47098e90ed0e7ab18e39',
            
            // Special addresses
            '0x0000000000000000000000000000000000000000', // Null address
            '0x000000000000000000000000000000000000dead', // Burn address
            
            // 1inch
            '0x1111111254fb6c44bac0bed2854e76f90643097d',
            '0x11111112542d85b3ef69ae05771c2dccff4faa26',
            
            // Uniswap
            '0x5c69bee701ef814a2b6a3edd4b1652cb9cc5aa6f',
            '0x7a250d5630b4cf539739df2c5dacb4c659f2488d',
            '0xe592427a0aece92de3edee1f18e0157c05861564',
            '0x68b3465833fb72a70ecdf485e0e4c7bd8665fc45',
            
            // SushiSwap
            '0xc2edad668740f1aa35e4d8f227fb8e17dca888cd',
            '0xd9e1ce17f2641f24ae83637ab66a2cca9c378b9f',
            
            // QuickSwap (Polygon)
            '0xa5e0829caced8ffdd4de3c43696c57f7d7a678ff',
            
            // Balancer
            '0xba12222222228d8ba445958a75a0704d566bf2c8',
            
            // Polygon Bridge
            '0x401f6c983ea34274ec46f84d70b31c151321188b',
            '0xa0c68c638235ee32657e8f720a23cec1bfc77c77',
            '0x40ec5b33f54e0e8a33a975908c5ba1c14e5bbbdf',
            
            // Additional non-retail from analysis
            '0x2580ccb2be946ad98effa7f4b76148bed319011c', // Telcoin Treasury Safe
            '0x92e43aec69207755cb1e6a8dc589aae630476330', // TransparentUpgradeableProxy
            '0x2ff79955aad11fa93b84d79d45f504e6168935bc', // Minimal Proxy Contract
            '0x11881f2a7e969bdc2bd25cc46ea4e2a0638a6ed4', // Minimal Proxy Contract
            '0x77edf95bbe3ac3c580647e6d7d13f0e8cd3c7b3b', // ClonableBeaconProxy
            '0x0c5996249a5e67cf50d2b778e76016749954c798', // TAO Distribution Safe
            '0x99ef9f86c41d2a5b1c609e910b06c20ca45a984c', // TAO Distribution Safe (matched by amount)
            '0xa9781d19e5611f65908dd6818fc1c276e2c6ac44', // TAO Distribution Safe
            '0xf4bc288d616c4f57071a57f5a4050b5e516fe7e5', // TAO Safe
            '0x3b0ff0c9f3e0c9d3fd0e0a9c3abd8e99b7f7abd4', // Uniswap V3 TEL 2
            '0x7f101fe45e6649a6e50f8ac8f847e0a1fa4c5325', // Railgun Relay
            '0xf35a6bd6e0459a4b53a27862c51a2a7292b383d1', // CoinSpot 1
            '0x4456dd6643c973a7a63d6b85b6f58aeeabaf7259', // Bitrue
            '0x49048044d57e1c92a77eacf3a1d9ba70885ca312', // Base Bridge
            '0x2a0c0dbecc7e4d658f48e01e3fa353f44050c208', // IDEX
            '0x8d12a197cb00d4747a1fe03395095ce2a5cc6819', // EtherDelta 2
            '0x3154cf16ccdb4c6d922629664174b904d80f2c35', // Large institutional holder
            '0x9f45bccdb42871a955e34d9d5ca33be9ccaef1fd', // Round balance institutional
            '0x84b94024463f01d5cbb3086f14f574d7ed83b794', // Round number institutional
            '0xb01b8d347d86451428338b24f5000717fd4f37bf', // Large institutional holder
            '0x067173cf1a20e1f7a952d3abd15537d86a239924', // Multi-chain holder
            '0x9756686f71e9a90558c7cfbad89e9fd8007f97e7', // Multi-chain holder
            '0xcf6994abe437e67b331cd2513f47773cd91244d2', // Multi-chain holder
            '0x20daacb0864ff9a5e07d05ea16fa56cd00fdc16d', // Large institutional holder// === Telcoin Association Governance / Council Safes ===
	    '0x2580ccb2be946ad98effa7f4b76148bed319011c', // TEL Treasury (Ethereum Temporary)
            '0xe4ccf475a8ca5c96edbcdcf77a13ef29253d0878', // TAO Implementation Wallet
  '0x32bc9a5d1743bf43cd8e989d0e4cc370af0ff2d6', // Platform Council
  '0xa9d6f0ed6e4a931492d3f6782dd1109f25d4a51', // Treasury Council
  '0x0454d503c210886227726c2bc306749e892e97591', // Compliance Council
  '0x583d596b0a79c0e83c87851ea9fb1a91e80290b2', // TELx Council
  '0x8dcf8d134f22ac625a7afb39514695801cd705b5', // TAN Council
  '0x661b0a1c74e2a6f915ee234f39d16b83f3a3057', // TAO Safe (legacy)
  '0xc4fbe4cfba8f39ea26f2105db885901af7a03d36', // TAN Distribution Safe
  '0x99ef9f86c41d2a5b1c609e910b06c20ca45a984c', // TAO Distribution Safe
  '0xada13f9e4814e4e3484e04b9f709534fd3ff3f3', // TELx Miner Safe
  '0x7307a372f49f7df1df25a30a377c8223967b82396', // Telcoin Staker Safe
  '0xaa976f4d6acfa9852c9482be350afce8c5f758e', // Telcoin Developer Safe
  '0x7415510a517ac439273910d89a1f0ba9a0cab368', // Telcoin Validator Safe

  // === Additional known TAO / Treasury safes (from prior versions) ===
  '0x0c5996249a5e67cf50d2b778e76016749954c798', // TAO Distribution Safe (legacy)
  '0xa9781d19e5611f65908dd6818fc1c276e2c6ac44', // TAO Distribution Safe (secondary)
  '0xf4bc288d616c4f57071a57f5a4050b5e516fe7e5', // TAO Safe (active operations)

            
        ].map(addr => addr.toLowerCase());
        
        // Function to check if an address is a mega holder (>20B tokens)
        function isMegaHolder(balance) {
            return balance > 20000000000; // 20 billion TEL
        }
        
        function isNonRetailAddress(address) {
            const addr = address.toLowerCase();
            
            // Direct match
            if (NON_RETAIL_ADDRESSES.includes(addr)) return true;
            
            // Pattern matching for common DEX/DeFi contracts
            if (addr.includes('uniswap')) return true;
            if (addr.includes('sushiswap')) return true;
            if (addr.includes('quickswap')) return true;
            if (addr.includes('balancer')) return true;
            if (addr.includes('curve')) return true;
            if (addr.includes('aave')) return true;
            if (addr.includes('compound')) return true;
            if (addr.includes('bridge')) return true;
            if (addr.includes('router')) return true;
            if (addr.includes('pool')) return true;
            if (addr.includes('vault')) return true;
            
            return false;
        }
        
        function showAlert(message, type = 'error') {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function parseCSV(text, debugId) {
            try {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    throw new Error('CSV file is empty');
                }
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    let address = '';
                    let balance = '';
                    
                    // Handle quoted CSV format (Ethereum)
                    if (line.startsWith('"')) {
                        const match = line.match(/^"(0x[a-fA-F0-9]{40})","([0-9,\.]+)"/);
                        if (match) {
                            address = match[1];
                            balance = match[2].replace(/,/g, '');
                        }
                    } else {
                        // Handle non-quoted format (Polygon)
                        const match = line.match(/^(0x[a-fA-F0-9]{40}),"([0-9,\.]+)"/);
                        if (match) {
                            address = match[1];
                            balance = match[2].replace(/,/g, '');
                        }
                    }
                    
                    const numBalance = parseFloat(balance);
                    if (address && !isNaN(numBalance) && numBalance > 0) {
                        data.push({
                            HolderAddress: address,
                            Balance: numBalance
                        });
                    }
                }
                
                if (debugMode) {
                    document.getElementById(debugId).innerHTML = `
                        Parsed ${data.length} valid holders<br>
                        Sample: ${data[0] ? data[0].HolderAddress + ' - ' + data[0].Balance : 'No data'}
                    `;
                    document.getElementById(debugId).style.display = 'block';
                }
                
                return data;
                
            } catch (error) {
                console.error('CSV parsing error:', error);
                if (debugMode) {
                    document.getElementById(debugId).innerHTML = `Error: ${error.message}`;
                    document.getElementById(debugId).style.display = 'block';
                }
                showAlert(`CSV parsing error: ${error.message}`);
                return [];
            }
        }
        
        document.getElementById('ethereumFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    ethereumData = parseCSV(e.target.result, 'ethereumDebug');
                    document.getElementById('ethereumStatus').innerHTML = `Loaded ${ethereumData.length} holders`;
                    checkReady();
                };
                reader.readAsText(file);
            }
        });
        
        document.getElementById('polygonFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    polygonData = parseCSV(e.target.result, 'polygonDebug');
                    document.getElementById('polygonStatus').innerHTML = `Loaded ${polygonData.length} holders`;
                    checkReady();
                };
                reader.readAsText(file);
            }
        });
        
        function checkReady() {
            const btn = document.getElementById('analyzeBtn');
            const hasEthereum = ethereumData !== null && ethereumData.length > 0;
            const hasPolygon = polygonData !== null && polygonData.length > 0;
            const loadedEthereum = ethereumData !== null;
            const loadedPolygon = polygonData !== null;

            if (hasEthereum || hasPolygon) {
                btn.disabled = false;
                btn.textContent = 'Analyze Holder Distribution';
            } else if (loadedEthereum || loadedPolygon) {
                btn.textContent = 'Check data - no holders found';
                btn.disabled = true;
            } else {
                btn.textContent = 'Please load CSV files';
                btn.disabled = true;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            const debugDivs = document.querySelectorAll('.debug-info');
            debugDivs.forEach(div => {
                div.style.display = debugMode ? 'block' : 'none';
            });
        }
        
        function analyzeData() {
            const hasEthereum = ethereumData !== null && ethereumData.length > 0;
            const hasPolygon = polygonData !== null && polygonData.length > 0;

            if (!hasEthereum && !hasPolygon) {
                showAlert('Please load at least one valid CSV file with holder data');
                return;
            }
            
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            progressBar.style.display = 'block';
            
            try {
                const allHolders = [];
                const excludedAddresses = new Set();
                const excludedBalances = { ethereum: 0, polygon: 0 };
                const totalProcessed = { ethereum: 0, polygon: 0 };
                
                progressFill.style.width = '25%';
                progressFill.textContent = 'Processing Ethereum data...';
                
                if (hasEthereum) {
                    ethereumData.forEach(holder => {
                        totalProcessed.ethereum += holder.Balance;
                        
                        if (isNonRetailAddress(holder.HolderAddress) || isMegaHolder(holder.Balance)) {
                            excludedAddresses.add(holder.HolderAddress.toLowerCase());
                            excludedBalances.ethereum += holder.Balance;
                        } else if (holder.Balance >= 1000) { 
                            allHolders.push({
                                address: holder.HolderAddress,
                                balance: holder.Balance,
                                chain: 'Ethereum'
                            });
                        }
                    });
                }
                
                progressFill.style.width = '50%';
                progressFill.textContent = 'Processing Polygon data...';
                
                if (hasPolygon) {
                    polygonData.forEach(holder => {
                        totalProcessed.polygon += holder.Balance;
                        
                        if (isNonRetailAddress(holder.HolderAddress) || isMegaHolder(holder.Balance)) {
                            excludedAddresses.add(holder.HolderAddress.toLowerCase());
                            excludedBalances.polygon += holder.Balance;
                        } else if (holder.Balance >= 1000) { 
                            allHolders.push({
                                address: holder.HolderAddress,
                                balance: holder.Balance,
                                chain: 'Polygon'
                            });
                        }
                    });
                }
                
                progressFill.style.width = '75%';
                progressFill.textContent = 'Calculating metrics...';
                
                if (allHolders.length === 0) {
                    showAlert('No valid holder data found after processing. Check your CSV format.');
                    progressBar.style.display = 'none';
                    return;
                }
                
                allHolders.sort((a, b) => b.balance - a.balance);
                
                const totalRetailSupply = allHolders.reduce((sum, holder) => sum + holder.balance, 0);
                
                const metrics = calculateConcentrationMetrics(allHolders, totalRetailSupply);
                
                progressFill.style.width = '100%';
                progressFill.textContent = 'Complete!';
                
                resultsData = { allHolders, metrics, excludedAddresses: Array.from(excludedAddresses), excludedBalances, totalRetailSupply, totalProcessed };
                
                displayResults(allHolders, metrics, excludedAddresses, excludedBalances, totalRetailSupply, totalProcessed);
                
                showAlert('Analysis completed successfully!', 'success');
                
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);
                
            } catch (error) {
                console.error('Analysis error:', error);
                showAlert(`Analysis error: ${error.message}`);
                progressBar.style.display = 'none';
            }
        }
        
        function calculateConcentrationMetrics(holders, totalSupply) {
            const metrics = {};
            
            const topN = [10, 25, 50, 100];
            topN.forEach(n => {
                const topHolders = holders.slice(0, n);
                const topBalance = topHolders.reduce((sum, h) => sum + h.balance, 0);
                metrics[`top${n}`] = {
                    count: Math.min(n, holders.length),
                    balance: topBalance,
                    percentage: (topBalance / totalSupply * 100).toFixed(2)
                };
            });
            
            const gini = calculateGiniCoefficient(holders.map(h => h.balance));
            metrics.gini = gini;
            
            const balances = holders.map(h => h.balance);
            const mean = balances.reduce((a, b) => a + b, 0) / balances.length;
            const variance = balances.reduce((sum, b) => sum + Math.pow(b - mean, 2), 0) / balances.length;
            const stdDev = Math.sqrt(variance);
            metrics.stdDev = stdDev;

            const brackets = [
                { min: 1000, max: 10000, label: '1K-10K' },
                { min: 10000, max: 100000, label: '10K-100K' },
                { min: 100000, max: 1000000, label: '100K-1M' },
                { min: 1000000, max: 10000000, label: '1M-10M' },
                { min: 10000000, max: 100000000, label: '10M-100M' },
                { min: 100000000, max: Infinity, label: '100M+' }
            ];
            
            metrics.distribution = brackets.map(bracket => {
                const holdersInBracket = holders.filter(h => 
                    h.balance >= bracket.min && h.balance < bracket.max
                );
                return {
                    label: bracket.label,
                    count: holdersInBracket.length,
                    totalBalance: holdersInBracket.reduce((sum, h) => sum + h.balance, 0)
                };
            });
            
            return metrics;
        }
        
        function calculateGiniCoefficient(values) {
            if (values.length === 0) return 0;
            
            const sorted = values.slice().sort((a, b) => a - b);
            const n = sorted.length;
            const totalSum = sorted.reduce((a, b) => a + b, 0);
            
            if (totalSum === 0) return 0;
            
            let giniSum = 0;
            for (let i = 0; i < n; i++) {
                giniSum += (n - i) * sorted[i];
            }
            
            return (n + 1 - 2 * giniSum / totalSum) / n;
        }
        
        function displayResults(holders, metrics, excludedAddresses, excludedBalances, totalRetailSupply, totalProcessed) {
            document.getElementById('results').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'inline-block';
            
            const totalHolders = holders.length;
            const ethereumHolders = holders.filter(h => h.chain === 'Ethereum').length;
            const polygonHolders = holders.filter(h => h.chain === 'Polygon').length;
            
            const totalExcluded = excludedBalances.ethereum + excludedBalances.polygon;
            const totalAnalyzed = totalProcessed.ethereum + totalProcessed.polygon;
            const unaccountedSupply = TOTAL_TEL_SUPPLY - totalAnalyzed;
            
            document.getElementById('summaryCard').innerHTML = `
                <h2 style="color: white; margin-top: 0;">Analysis Summary</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">${totalHolders.toLocaleString()}</div>
                        <div class="summary-label">Total Retail Holders</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${formatNumber(totalRetailSupply)}</div>
                        <div class="summary-label">Retail Supply (${(totalRetailSupply/TOTAL_TEL_SUPPLY*100).toFixed(1)}%)</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${formatNumber(totalExcluded)}</div>
                        <div class="summary-label">Non-Retail Supply (${(totalExcluded/TOTAL_TEL_SUPPLY*100).toFixed(1)}%)</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${formatNumber(TOTAL_TEL_SUPPLY)}</div>
                        <div class="summary-label">Total TEL Supply</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${ethereumHolders.toLocaleString()}</div>
                        <div class="summary-label">Ethereum Holders</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${polygonHolders.toLocaleString()}</div>
                        <div class="summary-label">Polygon Holders</div>
                    </div>
                </div>
                ${unaccountedSupply > 1000000 ? `
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 14px;">
                    <strong>Note:</strong> ${formatNumber(unaccountedSupply)} TEL (${(unaccountedSupply/TOTAL_TEL_SUPPLY*100).toFixed(1)}%) not accounted for in uploaded data - likely in other chains, locked, or burned.
                </div>
                ` : ''}
            `;
            
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = '';
            
            [10, 25, 50, 100].forEach(n => {
                const metric = metrics[`top${n}`];
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-label">Top ${n} Holders</div>
                    <div class="metric-value">${metric.percentage}%</div>
                    <div style="font-size: 12px; color: #666;">
                        ${formatNumber(metric.balance)} TEL<br>
                        ${metric.count} addresses
                    </div>
                `;
                metricsGrid.appendChild(card);
            });
            
            const spreadCard = document.createElement('div');
            spreadCard.className = 'metric-card';
            spreadCard.innerHTML = `
                <div class="metric-label">Distribution Spread (Gini)</div>
                <div class="metric-value">${(metrics.gini * 100).toFixed(1)}%</div>
                <div style="font-size: 12px; color: #666;">
                    ${metrics.gini < 0.3 ? 'Low concentration' : 
                      metrics.gini < 0.6 ? 'Moderate concentration' : 
                      'High concentration'}
                </div>
            `;
            metricsGrid.appendChild(spreadCard);
            
            const stdDevCard = document.createElement('div');
            stdDevCard.className = 'metric-card';
            stdDevCard.innerHTML = `
                <div class="metric-label">Balance Std Deviation</div>
                <div class="metric-value">${formatNumber(metrics.stdDev)}</div>
                <div style="font-size: 12px; color: #666;">
                    TEL
                </div>
            `;
            metricsGrid.appendChild(stdDevCard);
            
            document.getElementById('excludedAddresses').innerHTML = `
                <strong>Filtered Out:</strong> ${excludedAddresses.size} non-retail addresses<br>
                <strong>Excluded Balance:</strong> 
                Ethereum: ${formatNumber(excludedBalances.ethereum)} TEL | 
                Polygon: ${formatNumber(excludedBalances.polygon)} TEL<br>
                <strong>Total Excluded:</strong> ${formatNumber(totalExcluded)} TEL (${(totalExcluded/TOTAL_TEL_SUPPLY*100).toFixed(1)}% of total supply)<br>
                <strong>Categories Excluded:</strong> Major exchanges, DEX protocols, mega holders (>20B TEL), bridges, institutional wallets, and Telcoin infrastructure<br>
                <strong>Analysis Focus:</strong> Individual retail holders with 1,000+ TEL tokens
            `;
            
            const tbody = document.getElementById('topHoldersBody');
            tbody.innerHTML = '';
            holders.slice(0, 100).forEach((holder, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td style="font-family: monospace; font-size: 12px;">
                        ${holder.address.substring(0, 6)}...${holder.address.substring(38)}
                    </td>
                    <td>${formatNumber(holder.balance)}</td>
                    <td>${(holder.balance / totalRetailSupply * 100).toFixed(4)}% retail | ${(holder.balance / TOTAL_TEL_SUPPLY * 100).toFixed(4)}% total</td>
                    <td>${holder.chain}</td>
                `;
            });
            
            const distDiv = document.getElementById('distributionAnalysis');
            distDiv.innerHTML = '<h3>Holdings Distribution by Range</h3>';
            const distTable = document.createElement('table');
            distTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Range (TEL)</th>
                        <th>Holders</th>
                        <th>Total Balance</th>
                        <th>% of Supply</th>
                    </tr>
                </thead>
                <tbody>
                    ${metrics.distribution.map(d => `
                        <tr>
                            <td>${d.label}</td>
                            <td>${d.count.toLocaleString()}</td>
                            <td>${formatNumber(d.totalBalance)}</td>
                            <td>${(d.totalBalance / totalRetailSupply * 100).toFixed(2)}%</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            distDiv.appendChild(distTable);
        }
        
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }
        
        function downloadResults() {
            if (!resultsData) {
                showAlert('No results to download. Run analysis first.');
                return;
            }
            
            const { allHolders, metrics, excludedAddresses, excludedBalances, totalRetailSupply } = resultsData;
            
            let csvContent = 'Rank,Address,Balance,% of Retail Supply,Chain\n';
            allHolders.slice(0, 100).forEach((holder, index) => {
                csvContent += `${index + 1},${holder.address},${holder.balance},${(holder.balance / totalRetailSupply * 100).toFixed(4)},${holder.chain}\n`;
            });
            
            csvContent += '\nConcentration Metrics\n';
            csvContent += 'Top 10 %,' + metrics.top10.percentage + '\n';
            csvContent += 'Top 25 %,' + metrics.top25.percentage + '\n';
            csvContent += 'Top 50 %,' + metrics.top50.percentage + '\n';
            csvContent += 'Top 100 %,' + metrics.top100.percentage + '\n';
            csvContent += 'Gini Coefficient,' + metrics.gini + '\n';
            csvContent += 'Std Deviation,' + metrics.stdDev + '\n';
            
            csvContent += '\nDistribution\n';
            csvContent += 'Range,Holders,Total Balance,% of Supply\n';
            metrics.distribution.forEach(d => {
                csvContent += `${d.label},${d.count},${d.totalBalance},${(d.totalBalance / totalRetailSupply * 100).toFixed(2)}\n`;
            });
            
            csvContent += '\nExcluded\n';
            csvContent += 'Excluded Addresses,' + excludedAddresses.join(',') + '\n';
            csvContent += 'Excluded Ethereum Balance,' + excludedBalances.ethereum + '\n';
            csvContent += 'Excluded Polygon Balance,' + excludedBalances.polygon + '\n';
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'tel_holder_analysis_report.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>